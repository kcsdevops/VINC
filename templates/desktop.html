<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ULTRA DOWN AI - Download Ultra-R√°pido</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #0a0e27 0%, #1a1f3a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Header estilo Desktop */
        .desktop-header {
            background: linear-gradient(135deg, #1e2139 0%, #2a2d4a 100%);
            padding: 15px 30px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
            border-bottom: 2px solid #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-menu {
            display: flex;
            gap: 20px;
        }

        .nav-btn {
            padding: 8px 20px;
            background: rgba(102, 126, 234, 0.2);
            border: 1px solid #667eea;
            border-radius: 6px;
            color: #4fc3f7;
            cursor: pointer;
            transition: all 0.3s;
            text-decoration: none;
            font-size: 14px;
        }

        .nav-btn:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-2px);
        }

        .nav-btn-compact { margin: 0; padding: 8px 16px; cursor: pointer; }

        /* Container Principal */
        .desktop-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        /* Hero Section */
        .hero-section {
            text-align: center;
            margin-bottom: 40px;
        }

        .hero-title {
            font-size: 48px;
            font-weight: bold;
            background: linear-gradient(135deg, #4fc3f7 0%, #667eea 50%, #764ba2 100%);
            -webkit-background-clip: text;
            background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 15px;
        }

        .hero-subtitle {
            font-size: 18px;
            color: #b0bec5;
            margin-bottom: 30px;
        }

        .stats-bar {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 20px;
        }

        .stat-item {
            padding: 15px 30px;
            background: rgba(79, 195, 247, 0.1);
            border-radius: 10px;
            border: 1px solid rgba(79, 195, 247, 0.3);
        }

        .stat-number {
            font-size: 32px;
   https://pt.xhamster.com/videos/naughty-schoolgirl-was-fucked-by-stepdaddy-cowgirl-creampie-xhKNym0         font-weight: bold;
            color: #4fc3f7;
        }

        .stat-label {
            font-size: 12px;
            color: #81d4fa;
            margin-top: 5px;
        }

        /* Abas de Filtro */
        .download-tab {
            transition: all 0.3s ease;
        }
        
        .download-tab:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        
        .active-tab {
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.6);
        }

        /* Caixa de Download Principal */
        .download-box {
            width: 100%;
            max-width: 800px;
            background: linear-gradient(135deg, #1e2139 0%, #2a2d4a 100%);
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 2px solid #667eea;
            margin-bottom: 30px;
        }

        .input-wrapper {
            position: relative;
            margin-bottom: 20px;
        }

        .url-input {
            width: 100%;
            padding: 20px;
            font-size: 16px;
            background: #0f1326;
            border: 2px solid #3a3d5a;
            border-radius: 12px;
            color: #e0e0e0;
            transition: all 0.3s;
        }

        .url-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.4);
        }

        .download-btn {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            font-weight: bold;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 12px;
            color: white;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .download-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 30px rgba(102, 126, 234, 0.6);
        }

        .download-btn:active {
            transform: translateY(-1px);
        }

        /* Atalhos R√°pidos */
        .shortcuts {
            background: rgba(79, 195, 247, 0.05);
            padding: 15px;
            border-radius: 10px;
            border: 1px solid rgba(79, 195, 247, 0.2);
            margin-top: 20px;
        }

        .shortcuts-title {
            color: #4fc3f7;
            font-weight: bold;
            margin-bottom: 10px;
            font-size: 14px;
        }

        .shortcuts-list {
            font-size: 12px;
            color: #b0bec5;
            line-height: 1.8;
        }

        .shortcut-code {
            background: #0d47a1;
            padding: 2px 8px;
            border-radius: 4px;
            color: #81d4fa;
            font-family: 'Courier New', monospace;
        }

        /* Resultados */
        .results-container {
            width: 100%;
            max-width: 800px;
            display: none;
        }

        .results-container.show {
            display: block;
        }

        .video-card {
            background: linear-gradient(135deg, #1e2139 0%, #2a2d4a 100%);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            border: 2px solid #3a3d5a;
            transition: all 0.3s;
        }

        .video-card:hover {
            border-color: #667eea;
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .video-header {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .video-thumbnail {
            width: 200px;
            height: 112px;
            border-radius: 10px;
            object-fit: cover;
        }

        .video-info {
            flex: 1;
        }

        .video-title {
            font-size: 18px;
            font-weight: bold;
            color: #e0e0e0;
            margin-bottom: 10px;
        }

        .video-meta {
            font-size: 13px;
            color: #888;
        }

        .quality-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .quality-btn {
            padding: 12px;
            background: rgba(79, 195, 247, 0.1);
            border: 1px solid #4fc3f7;
            border-radius: 8px;
            color: #4fc3f7;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
            font-size: 13px;
        }

        .quality-btn:hover {
            background: linear-gradient(135deg, #4fc3f7 0%, #667eea 100%);
            color: white;
            transform: scale(1.05);
        }

        .quality-label {
            font-weight: bold;
            font-size: 16px;
        }

        .quality-details {
            font-size: 10px;
            margin-top: 3px;
            opacity: 0.8;
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 20px;
        }

        .loading.show {
            display: block;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid rgba(79, 195, 247, 0.2);
            border-top-color: #4fc3f7;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 15px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Footer */
        .desktop-footer {
            background: #1e2139;
            padding: 20px;
            text-align: center;
            color: #888;
            font-size: 13px;
            border-top: 1px solid #3a3d5a;
        }

        /* Notifica√ß√µes */
        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 25px;
            border-radius: 10px;
            color: white;
            font-weight: bold;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease-out;
        }

        .notification.show {
            display: block;
        }

        .notification.success {
            background: linear-gradient(135deg, #2e7d32 0%, #4caf50 100%);
        }

        .notification.error {
            background: linear-gradient(135deg, #c62828 0%, #f44336 100%);
        }

        @keyframes slideIn {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .hero-title {
                font-size: 32px;
            }

            .stats-bar {
                flex-direction: column;
                gap: 15px;
            }

            .download-box {
                padding: 25px;
            }

            .video-header {
                flex-direction: column;
            }

            .video-thumbnail {
                width: 100%;
                height: auto;
            }

            .quality-grid {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        /* Monitor & Controls */
        .monitor-container { display: none; margin-top: 30px; background: rgba(26,31,58,0.8); border-radius: 15px; padding: 20px; border: 2px solid #667eea; }
        .monitor-header { display:flex; justify-content: space-between; align-items:center; margin-bottom:15px; }
        .monitor-title { color:#667eea; margin:0; }
        .btn-outline-blue { background: rgba(255,255,255,0.1); border: 1px solid #667eea; color:#667eea; padding: 8px 15px; border-radius:8px; cursor:pointer; }
        .tabs-bar { display:flex; gap:10px; margin-bottom:15px; border-bottom:2px solid rgba(102,126,234,0.3); padding-bottom:10px; }
        .download-tab { flex:1; background: rgba(255,255,255,0.1); border:none; color:#e0e0e0; padding:10px; border-radius:8px 8px 0 0; cursor:pointer; font-weight:bold; transition: all 0.3s; }
        .download-tab.active-tab { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color:#fff; }
        .downloads-path { background: rgba(0,0,0,0.3); padding:12px; border-radius:8px; margin-bottom:15px; display:flex; justify-content:space-between; align-items:center; gap:10px; }
        .flex-1 { flex: 1; }
        .downloads-path-label { color:#4fc3f7; font-size:14px; margin-bottom:5px; }
        .downloads-path-text { color:#e0e0e0; font-family: 'Courier New', monospace; font-size:13px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
        .btn-row { display:flex; gap:8px; }
        .btn-outline-cyan { background: rgba(255,255,255,0.1); border:1px solid #4fc3f7; color:#4fc3f7; padding:10px 14px; border-radius:8px; cursor:pointer; font-weight:bold; }
        .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border:none; color:#fff; padding:10px 20px; border-radius:8px; cursor:pointer; font-weight:bold; }
        .scroll-area { max-height:300px; overflow-y:auto; }
    </style>
</head>
<body>
    <!-- Header -->
    <div class="desktop-header">
        <div class="logo">
            <span>‚ö°</span> ULTRA DOWN AI
        </div>
        <div class="nav-menu">
            <a href="/" class="nav-btn">üè† P√°gina Inicial</a>
            <a href="/express" class="nav-btn">‚ö° Express</a>
            <a href="/batch" class="nav-btn">üì¶ Batch</a>
        </div>
    </div>

    <!-- Container Principal -->
    <div class="desktop-container">
        <!-- Hero Section -->
        <div class="hero-section">
            <div class="hero-title">Download Ultra-R√°pido</div>
            <div class="hero-subtitle">
                üí® Velocidade extrema com 32 conex√µes paralelas e buffer de 64MB
            </div>
            <div class="stats-bar">
                <div class="stat-item">
                    <div class="stat-number">1000+</div>
                    <div class="stat-label">Sites Suportados</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number">32x</div>
                    <div class="stat-label">Mais R√°pido</div>
                </div>
                <div class="stat-item">
                    <div class="stat-number" id="totalDownloaded">0 GB</div>
                    <div class="stat-label">Total Baixado</div>
                </div>
                <div class="stat-item">
                    <button class="nav-btn nav-btn-compact" onclick="openDownloadFolder()">
                        üìÇ Abrir Pasta
                    </button>
                </div>
            </div>
        </div>

        <!-- Caixa de Download -->
        <div class="download-box">
            <div class="input-wrapper">
                <input 
                    type="text" 
                    id="urlInput" 
                    class="url-input"
                    placeholder="Cole a URL do v√≠deo aqui (YouTube, Instagram, TikTok, Facebook, xHamster...)"
                    autocomplete="off"
                >
            </div>
            <button class="download-btn" onclick="analyzeUrl()">
                üöÄ ANALISAR E BAIXAR
            </button>

            <!-- Atalhos -->
            <div class="shortcuts">
                <div class="shortcuts-title">üí° ATALHOS R√ÅPIDOS:</div>
                <div class="shortcuts-list">
                    ‚Ä¢ YouTube: <span class="shortcut-code">udyoutube.com/...</span><br>
                    ‚Ä¢ Qualquer site: <span class="shortcut-code">udai.com/https://...</span><br>
                    ‚Ä¢ Ou cole a URL completa normalmente
                </div>
            </div>
        </div>

        <!-- Loading -->
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <div class="label-strong" style="text-align:center; color:#4fc3f7;">Analisando v√≠deo...</div>
        </div>

        <!-- Resultados -->
        <div class="results-container" id="results"></div>
        
        <!-- Se√ß√£o de Monitoramento de Downloads -->
        <div id="downloadMonitor" class="monitor-container">
            <div class="monitor-header">
                <h3 class="monitor-title">üì• Monitor de Downloads</h3>
                <button onclick="toggleMonitor()" class="btn-outline-blue">
                    Minimizar
                </button>
            </div>
            
            <!-- Abas de Filtro -->
            <div class="tabs-bar">
                <button onclick="filterDownloads('all')" id="tab-all" class="download-tab active-tab">
                    üìä Todos (<span id="count-all">0</span>)
                </button>
                <button onclick="filterDownloads('downloading')" id="tab-downloading" class="download-tab">
                    üì• Baixando (<span id="count-downloading">0</span>)
                </button>
                <button onclick="filterDownloads('completed')" id="tab-completed" class="download-tab">
                    ‚úÖ Conclu√≠dos (<span id="count-completed">0</span>)
                </button>
                <button onclick="filterDownloads('error')" id="tab-error" class="download-tab">
                    ‚ùå Erros (<span id="count-error">0</span>)
                </button>
            </div>
            
            <!-- Pasta de Download -->
            <div class="downloads-path">
                <div class="flex-1">
                    <div class="downloads-path-label">üìÇ Pasta de Downloads:</div>
                    <div class="downloads-path-text" id="downloadPath">C:\\Users\\renov\\Documents\\z\\downloads</div>
                </div>
                <div class="btn-row">
                    <button onclick="selectDownloadFolder()" class="btn-outline-cyan">
                        Selecionar Pasta
                    </button>
                    <button onclick="openDownloadFolder()" class="btn-primary">
                        Abrir Pasta
                    </button>
                </div>
            </div>
            
            <!-- Lista de Downloads -->
            <div id="downloadList" class="scroll-area">
                <!-- Downloads ser√£o inseridos aqui dinamicamente -->
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="desktop-footer">
        üé¨ ULTRA DOWN AI - Download de v√≠deos de 1000+ sites com velocidade extrema<br>
        ‚ö° Powered by yt-dlp + aria2c + Ultra Optimizations
    </div>

    <!-- Notifica√ß√£o -->
    <div class="notification" id="notification"></div>

    <script>
        let currentVideo = null;
        let analyzedVideos = [];
        let analyzedMeta = { title: '', content_type: 'single' };
        let totalBytesDownloaded = 0;

        // Carregar estat√≠sticas do localStorage
        function loadStats() {
            const saved = localStorage.getItem('totalBytesDownloaded');
            if (saved) {
                totalBytesDownloaded = Number.parseInt(saved);
                updateStatsDisplay();
            }
        }

        // Atualizar display de estat√≠sticas
        function updateStatsDisplay() {
            const gb = (totalBytesDownloaded / (1024 * 1024 * 1024)).toFixed(2);
            document.getElementById('totalDownloaded').textContent = `${gb} GB`;
        }

        // Adicionar bytes baixados
        function addDownloadedBytes(bytes) {
            totalBytesDownloaded += bytes;
            localStorage.setItem('totalBytesDownloaded', totalBytesDownloaded);
            updateStatsDisplay();
        }

        // Abrir pasta de downloads
        async function openDownloadFolder() {
            try {
                const response = await fetch('/api/open-download-folder', {
                    method: 'POST'
                });
                const result = await response.json();
                if (result.success) {
                    showNotification('üìÇ Pasta de downloads aberta!');
                } else {
                    showNotification('‚ùå Erro ao abrir pasta: ' + result.error, 'error');
                }
            } catch (error) {
                showNotification('‚ùå Erro: ' + error.message, 'error');
            }
        }

        // Gerenciar monitor de downloads
        const activeDownloads = new Map();
        
        // Carregar configura√ß√µes do servidor
        async function loadServerConfig() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();
                if (config.success) {
                    const pathElement = document.getElementById('downloadPath');
                    if (pathElement) {
                        // Preferir pasta do host, sen√£o caminho interno
                        pathElement.textContent = config.host_download_path || config.download_path;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar configura√ß√µes:', error);
            }
        }
        
        // Selecionar pasta via di√°logo nativo e salvar
        async function selectDownloadFolder(){
            try{
                const resp = await fetch('/api/select-folder',{method:'POST'});
                const data = await resp.json();
                if(!resp.ok || !data.success){
                    if(data.cancelled){ return; }
                    showNotification('‚ùå Erro ao selecionar pasta: ' + (data.error||'Falha'), 'error');
                    return;
                }
                const chosen = data.path;
                // Atualiza visual
                const el = document.getElementById('downloadPath');
                if (el) el.textContent = chosen;
                // Persiste em config
                const save = await fetch('/api/config',{
                    method:'POST',
                    headers:{'Content-Type':'application/json'},
                    body: JSON.stringify({ host_download_path: chosen })
                });
                const sv = await save.json();
                if(!save.ok || !sv.success){
                    showNotification('‚ö†Ô∏è Pasta aplicada, mas falha ao salvar prefer√™ncias', 'error');
                } else {
                    showNotification('‚úÖ Pasta de downloads atualizada!');
                }
            }catch(e){
                showNotification('‚ùå Erro: ' + e.message, 'error');
            }
        }
        
        function toggleMonitor() {
            const listDiv = document.getElementById('downloadList');
            if (listDiv.style.display === 'none') {
                listDiv.style.display = 'block';
            } else {
                listDiv.style.display = 'none';
            }
        }
        
        // Controle de filtros e abas
        let currentFilter = 'all';
        
        function filterDownloads(filter) {
            currentFilter = filter;
            
            // Atualizar estilo das abas
            for (const tab of document.querySelectorAll('.download-tab')) {
                if (tab.id === `tab-${filter}`) {
                    tab.classList.add('active-tab');
                } else {
                    tab.classList.remove('active-tab');
                }
            }
            
            // Filtrar downloads
            for (const [videoId, download] of activeDownloads) {
                const element = document.getElementById(`download-${videoId}`);
                if (element) {
                    if (filter === 'all') {
                        element.style.display = 'block';
                    } else {
                        element.style.display = download.status === filter ? 'block' : 'none';
                    }
                }
            }
        }
        
        function updateDownloadCounts() {
            const counts = {
                all: 0,
                downloading: 0,
                completed: 0,
                error: 0
            };
            
            for (const [, download] of activeDownloads) {
                counts.all++;
                if (download.status) {
                    counts[download.status] = (counts[download.status] || 0) + 1;
                }
            }
            
            document.getElementById('count-all').textContent = counts.all;
            document.getElementById('count-downloading').textContent = counts.downloading;
            document.getElementById('count-completed').textContent = counts.completed;
            document.getElementById('count-error').textContent = counts.error;
        }
        
        function addToMonitor(videoId, title) {
            const monitor = document.getElementById('downloadMonitor');
            const listDiv = document.getElementById('downloadList');
            
            // Mostrar monitor
            monitor.style.display = 'block';
            
            // Adicionar item √† lista
            const downloadItem = document.createElement('div');
            downloadItem.id = `download-${videoId}`;
            downloadItem.style.cssText = 'background: rgba(0,0,0,0.4); padding: 15px; border-radius: 10px; margin-bottom: 10px; border-left: 4px solid #667eea;';
            downloadItem.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <div style="color: #e0e0e0; font-weight: bold; flex: 1;">${title.substring(0, 60)}${title.length > 60 ? '...' : ''}</div>
                    <div id="status-${videoId}" style="color: #4fc3f7; font-size: 12px;">Iniciando...</div>
                </div>
                <div style="background: rgba(255,255,255,0.1); height: 8px; border-radius: 4px; overflow: hidden;">
                    <div id="progress-${videoId}" style="background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); height: 100%; width: 0%; transition: width 0.3s;"></div>
                </div>
                <div style="display: flex; justify-content: space-between; margin-top: 5px; font-size: 11px; color: #888;">
                    <span id="speed-${videoId}">--</span>
                    <span id="eta-${videoId}">--</span>
                </div>
            `;
            
            listDiv.appendChild(downloadItem);
            activeDownloads.set(videoId, {title, element: downloadItem, status: 'downloading'});
            updateDownloadCounts();
        }
        
        function updateMonitorProgress(videoId, progress, status, speed, eta) {
            const progressBar = document.getElementById(`progress-${videoId}`);
            const statusText = document.getElementById(`status-${videoId}`);
            const speedText = document.getElementById(`speed-${videoId}`);
            const etaText = document.getElementById(`eta-${videoId}`);
            
            // Atualizar status no Map
            const download = activeDownloads.get(videoId);
            if (download) {
                download.status = status;
                activeDownloads.set(videoId, download);
                updateDownloadCounts();
            }
            
            if (progressBar) progressBar.style.width = `${progress}%`;
            if (statusText) {
                if (status === 'completed') {
                    statusText.textContent = '‚úÖ Conclu√≠do';
                    statusText.style.color = '#4caf50';
                } else if (status === 'error') {
                    statusText.textContent = '‚ùå Erro';
                    statusText.style.color = '#f44336';
                } else if (status === 'downloading') {
                    statusText.textContent = `üì• ${progress}%`;
                    statusText.style.color = '#4fc3f7';
                }
            }
            if (speedText && speed) speedText.textContent = `‚ö° ${speed}`;
            if (etaText && eta) etaText.textContent = `‚è±Ô∏è ${eta}`;
        }
        
        function removeFromMonitor(videoId, delay = 5000) {
            setTimeout(() => {
                const element = document.getElementById(`download-${videoId}`);
                if (element) {
                    element.style.transition = 'opacity 0.5s';
                    element.style.opacity = '0';
                    setTimeout(() => {
                        element.remove();
                        activeDownloads.delete(videoId);
                        updateDownloadCounts();
                        
                        // Esconder monitor se n√£o houver downloads
                        if (activeDownloads.size === 0) {
                            document.getElementById('downloadMonitor').style.display = 'none';
                        }
                    }, 500);
                }
            }, delay);
        }

        // Carregar stats ao iniciar
        loadStats();
        loadServerConfig();

        function showNotification(message, type = 'success') {
            const notification = document.getElementById('notification');
            notification.textContent = message;
            notification.className = `notification ${type} show`;
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function showLoading(show) {
            document.getElementById('loading').classList.toggle('show', show);
        }

        async function analyzeUrl() {
            const urlInput = document.getElementById('urlInput');
            const url = urlInput.value.trim();

            if (!url) {
                showNotification('Por favor, cole uma URL', 'error');
                return;
            }

            showLoading(true);
            document.getElementById('results').classList.remove('show');

            try {
                console.log('Enviando requisi√ß√£o para:', '/api/smart-analyze');
                console.log('URL do v√≠deo:', url);
                
                const response = await fetch('/api/smart-analyze', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ url })
                });

                console.log('Status da resposta:', response.status);
                console.log('Headers:', response.headers);

                // Verificar se a resposta √© JSON
                const contentType = response.headers.get('content-type');
                console.log('Content-Type:', contentType);
                
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    console.error('Resposta n√£o √© JSON:', text.substring(0, 500));
                    showLoading(false);
                    showNotification('‚ùå Erro: Servidor retornou HTML em vez de JSON. Verifique o console (F12)', 'error');
                    return;
                }

                const data = await response.json();
                showLoading(false);

                if (data.success) {
                    displayResults(data);
                    showNotification('‚úÖ V√≠deo analisado com sucesso!');
                } else {
                    showNotification(`‚ùå Erro: ${data.error}`, 'error');
                }
            } catch (error) {
                showLoading(false);
                console.error('Erro completo:', error);
                showNotification(`‚ùå Erro na an√°lise: ${error.message}`, 'error');
            }
        }

        function displayResults(data) {
            const resultsContainer = document.getElementById('results');
            
            if (data.videos && data.videos.length > 0) {
                analyzedVideos = data.videos;
                analyzedMeta = { title: data.title || 'Conte√∫do', content_type: data.content_type || (data.videos.length>1?'playlist':'single') };
                const video = data.videos[0];
                currentVideo = video;

                let qualitiesHtml = '';
                if (video.formats && video.formats.length > 0) {
                    qualitiesHtml = video.formats.map(format => `
                        <button class="quality-btn" onclick="downloadQuality('${format.format_id}', false)">
                            <div class="quality-label">${format.quality}</div>
                            <div class="quality-details">${format.resolution}</div>
                            <div class="quality-details">${format.filesize}</div>
                        </button>
                    `).join('');
                    
                    // Adicionar op√ß√£o de √°udio
                    qualitiesHtml += `
                        <button class="quality-btn" onclick="downloadQuality('best', true)" style="background: rgba(76, 175, 80, 0.2); border-color: #4caf50; color: #4caf50;">
                            <div class="quality-label">üéµ √ÅUDIO</div>
                            <div class="quality-details">MP3 320kbps</div>
                            <div class="quality-details">Apenas √°udio</div>
                        </button>
                    `;
                } else {
                    // Fallback: formatos ausentes (ex.: TikTok/Instagram). Oferecer op√ß√µes gen√©ricas.
                    qualitiesHtml = `
                        <button class="quality-btn" onclick="downloadQuality('best', false)" style="background: rgba(79,195,247,0.15); border-color:#4fc3f7; color:#4fc3f7;">
                            <div class="quality-label">üì• V√çDEO (MELHOR)</div>
                            <div class="quality-details">Qualidade autom√°tica</div>
                            <div class="quality-details">mp4/webm</div>
                        </button>
                        <button class="quality-btn" onclick="downloadQuality('best', true)" style="background: rgba(76, 175, 80, 0.2); border-color: #4caf50; color: #4caf50;">
                            <div class="quality-label">üéµ √ÅUDIO</div>
                            <div class="quality-details">MP3 320kbps</div>
                            <div class="quality-details">Apenas √°udio</div>
                        </button>
                    `;
                }

                resultsContainer.innerHTML = `
                    <div class="video-card">
                        <div class="video-header">
                            <img src="${video.thumbnail || ''}" alt="Thumbnail" class="video-thumbnail" 
                                 onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22200%22 height=%22112%22%3E%3Crect fill=%22%23333%22 width=%22200%22 height=%22112%22/%3E%3C/svg%3E'">
                            <div class="video-info">
                                <div class="video-title">${video.title}</div>
                                <div class="video-meta">
                                    ‚è±Ô∏è ${video.duration || 'N/A'} ‚Ä¢ 
                                    üë§ ${video.uploader || 'Desconhecido'} ‚Ä¢ 
                                    üëÅÔ∏è ${video.view_count ? video.view_count.toLocaleString() : 'N/A'} views
                                </div>
                            </div>
                        </div>
                        <div style="color: #4fc3f7; font-weight: bold; margin-bottom: 10px;">
                            üéØ Escolha a qualidade (clique para iniciar o download):
                        </div>
                        
                        <!-- Bot√µes de Download em Massa -->
                        <div style="display: flex; gap: 10px; margin-bottom: 15px;">
                            <button class="quality-btn" onclick="downloadAllVideos()" style="flex: 1; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border: 2px solid #667eea;">
                                <div class="quality-label">üì• BAIXAR TODOS</div>
                                <div class="quality-details">${analyzedVideos.length>1 ? analyzedVideos.length + ' itens' : 'Melhor qualidade'}</div>
                                <div class="quality-details">${analyzedVideos.length>1 ? 'Playlist/Canal' : 'V√≠deo atual'}</div>
                            </button>
                            <button class="quality-btn" onclick="downloadAllAudios()" style="flex: 1; background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); border: 2px solid #f093fb;">
                                <div class="quality-label">üéµ BAIXAR √ÅUDIOS</div>
                                <div class="quality-details">${analyzedVideos.length>1 ? analyzedVideos.length + ' itens' : 'MP3 320kbps'}</div>
                                <div class="quality-details">${analyzedVideos.length>1 ? 'Playlist/Canal' : 'Apenas √°udio'}</div>
                            </button>
                        </div>
                        
                        <div class="quality-grid">
                            ${qualitiesHtml || '<div style="color: #888;">Carregando formatos...</div>'}
                        </div>
                    </div>
                `;
                resultsContainer.classList.add('show');
            }
        }

        async function downloadQuality(formatId, audioOnly) {
            if (!currentVideo) return;

            const videoId = `desktop_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            
            // Adicionar ao monitor
            addToMonitor(videoId, currentVideo.title);
            
            showNotification('üöÄ Download iniciado com velocidade extrema!');

            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: currentVideo.url,
                        video_id: videoId,
                        quality: formatId,
                        audio_only: audioOnly,
                        mp3_bitrate: '320',
                        audio_format: 'mp3'
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showNotification(`‚úÖ Download em andamento: ${currentVideo.title.substring(0, 40)}...`);
                    // Monitorar progresso
                    monitorDownload(videoId);
                } else {
                    showNotification(`‚ùå Erro: ${result.error}`, 'error');
                    updateMonitorProgress(videoId, 0, 'error', '', '');
                    removeFromMonitor(videoId, 3000);
                }
            } catch (error) {
                showNotification(`‚ùå Erro: ${error.message}`, 'error');
                updateMonitorProgress(videoId, 0, 'error', '', '');
                removeFromMonitor(videoId, 3000);
            }
        }

        // Inicia download para uma URL espec√≠fica (sem depender de currentVideo)
        async function downloadUrlWithFormat(url, title, formatId, audioOnly){
            const videoId = `desktop_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
            addToMonitor(videoId, title || url);
            try {
                const response = await fetch('/api/download', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        url: url,
                        video_id: videoId,
                        quality: formatId,
                        audio_only: !!audioOnly,
                        mp3_bitrate: '320',
                        audio_format: 'mp3'
                    })
                });
                const result = await response.json();
                if (result.success) {
                    monitorDownload(videoId);
                } else {
                    updateMonitorProgress(videoId, 0, 'error', '', '');
                    removeFromMonitor(videoId, 3000);
                }
            } catch (e) {
                updateMonitorProgress(videoId, 0, 'error', '', '');
                removeFromMonitor(videoId, 3000);
            }
        }

        // Fila de downloads
        const downloadQueue = [];
        let isProcessingQueue = false;
        const MAX_CONCURRENT_DOWNLOADS = 10;
        let activeDownloadCount = 0;

        async function processDownloadQueue() {
            if (isProcessingQueue) return;
            isProcessingQueue = true;

            while (downloadQueue.length > 0 && activeDownloadCount < MAX_CONCURRENT_DOWNLOADS) {
                const downloadTask = downloadQueue.shift();
                activeDownloadCount++;
                
                try {
                    await downloadTask();
                    await new Promise(resolve => setTimeout(resolve, 1000)); // 1 segundo entre downloads
                } catch (error) {
                    console.error('Erro no download:', error);
                }
                
                activeDownloadCount--;
            }

            isProcessingQueue = false;
            
            if (downloadQueue.length > 0) {
                setTimeout(() => processDownloadQueue(), 2000);
            }
        }

        function addToDownloadQueue(downloadFunc) {
            downloadQueue.push(downloadFunc);
            processDownloadQueue();
        }

        async function downloadAllVideos() {
            if (analyzedVideos && analyzedVideos.length > 1) {
                showNotification(`üöÄ Iniciando ${analyzedVideos.length} v√≠deos (melhor qualidade)`, 'success');
                for (const v of analyzedVideos) {
                    addToDownloadQueue(async () => {
                        await downloadUrlWithFormat(v.url || v.webpage_url || v.id, v.title || 'V√≠deo', 'best', false);
                    });
                }
                processDownloadQueue();
                return;
            }
            // Fallback: item √∫nico
            if (!currentVideo) { showNotification('‚ùå Nenhum v√≠deo', 'error'); return; }
            if (currentVideo.formats && currentVideo.formats.length > 0) {
                const bestFormat = currentVideo.formats[0];
                addToDownloadQueue(async () => { await downloadQuality(bestFormat.format_id, false); });
            } else {
                addToDownloadQueue(async () => { await downloadQuality('best', false); });
            }
        }

        async function downloadAllAudios() {
            if (analyzedVideos && analyzedVideos.length > 1) {
                showNotification(`üéµ Iniciando √°udio de ${analyzedVideos.length} itens (MP3 320kbps)`, 'success');
                for (const v of analyzedVideos) {
                    addToDownloadQueue(async () => {
                        await downloadUrlWithFormat(v.url || v.webpage_url || v.id, v.title || '√Åudio', 'best', true);
                    });
                }
                processDownloadQueue();
                return;
            }
            if (!currentVideo) { showNotification('‚ùå Nenhum v√≠deo selecionado', 'error'); return; }
            addToDownloadQueue(async () => { await downloadQuality('best', true); });
        }

        function monitorDownload(videoId) {
            const interval = setInterval(async () => {
                try {
                    const response = await fetch(`/api/download-status/${videoId}`);
                    const status = await response.json();

                    // Atualizar UI do monitor
                    updateMonitorProgress(
                        videoId, 
                        status.progress || 0, 
                        status.status,
                        status.speed || '',
                        status.eta || ''
                    );

                    if (status.status === 'completed') {
                        clearInterval(interval);
                        
                        // Adicionar bytes baixados √†s estat√≠sticas
                        if (status.file_size) {
                            addDownloadedBytes(status.file_size);
                        } else if (currentVideo && currentVideo.formats) {
                            // Estimar tamanho baseado no formato selecionado
                            const format = currentVideo.formats.find(f => f.format_id === status.format_id);
                            if (format && format.filesize && format.filesize !== 'N/A') {
                                const sizeMB = Number.parseFloat(format.filesize);
                                addDownloadedBytes(sizeMB * 1024 * 1024);
                            }
                        }
                        
                        showNotification('‚úÖ Download conclu√≠do com sucesso!');
                        
                        // Remover do monitor ap√≥s 5 segundos
                        removeFromMonitor(videoId, 5000);
                    } else if (status.status === 'error') {
                        clearInterval(interval);
                        showNotification(`‚ùå Erro: ${status.error}`, 'error');
                        
                        // Remover do monitor ap√≥s 3 segundos
                        removeFromMonitor(videoId, 3000);
                    }
                } catch (error) {
                    console.error('Erro ao monitorar:', error);
                }
            }, 2000);
        }

        // Enter para analisar
        document.getElementById('urlInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                analyzeUrl();
            }
        });
    </script>
</body>
</html>
